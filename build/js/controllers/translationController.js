"use strict";eyeApp.controller("translationController",function($scope,$http,$websocket,socketService){var video,webRtcPeer=null,constraints={audio:!0,video:{mandatory:{maxHeight:480,maxWidth:640,minFrameRate:30,maxFrameRate:30}}};$scope.comments=[],$scope.commentValue;var oId=$scope.ownerId;$scope.cameraId,$scope.accountTypeId,$scope.userAvatar,$scope.userName,$scope.userId,$scope.ws=socketService.get(),$scope.ws.init($websocket),$scope.cameraIndex=0,$scope.initWs=function(){$scope.ws.dataStream.onMessage(function(_message){var message=JSON.parse(_message.data);switch(message.id){case"iceCandidate":webRtcPeer.addIceCandidate(message.candidate);break;case"cameraConnectSuccess":$scope.connectSuccess(message);break;case"sendCommentSuccess":$scope.addComment(message);break;case"enterViewerSuccess":$scope.viewer(),$scope.getComments();break;case"viewerResponse":webRtcPeer.processAnswer(message.sdpAnswer);break;case"setCameraId":$scope.cameraId=message.cameraId,$scope.createTranslation()}})},$scope.$on("$destroy",function(){"Presenter"===$scope.translationType?($scope.stopTranslation(),webRtcPeer.dispose(),webRtcPeer=null):"Viewer"===$scope.translationType?($scope.exitViewer(oId),$scope.disconnectViewer(),webRtcPeer.dispose(),webRtcPeer=null):$scope.disconnectViewer()}),$scope.addComment=function(message){$scope.comments.unshift(message)},$scope.createTranslation=function(){if(video=angular.element(document.querySelector("#video"))[0],$scope.commentValue=$scope.commentValue,webRtcPeer)$scope.ws.methods.translationStop(localStorage.getItem("access_token"));else{var options={localVideo:video,mediaConstraints:constraints,onicecandidate:$scope.onIceCandidate};webRtcPeer=kurentoUtils.WebRtcPeer.WebRtcPeerSendonly(options,function(error){if(error)return console.log(error);this.generateOffer(function(error,sdpOffer){error?console.log(error):$scope.ws.methods.translationStart(localStorage.getItem("access_token"),sdpOffer,$scope.cameraId)})})}},$scope.stopTranslation=function(){$scope.ws.methods.translationStop(localStorage.getItem("access_token"))},$scope.connectSuccess=function(message){$scope.ownerId=$scope.profileid,webRtcPeer.processAnswer(message.sdpAnswer)},$scope.onIceCandidate=function(candidate){$scope.ws.methods.sendIceCandidate(localStorage.getItem("access_token"),candidate,$scope.cameraId)},$scope.sendComment=function(comment,$event){comment&&(13==$event.which&&($scope.ws.methods.sendComment(localStorage.getItem("access_token"),oId,comment),angular.element(".sendMessage input").val("")))},$scope.answerToComment=function(name){angular.element(".sendMessage > input").val("@ "+name+", ")},$scope.getCameraId=function(){$scope.ws.methods.getCameraId(localStorage.getItem("access_token"))},$scope.viewer=function(){if(video=angular.element(document.querySelector("#video"))[0],$scope.commentValue=$scope.commentValue,!webRtcPeer){var options={remoteVideo:video,onicecandidate:$scope.onIceCandidate};webRtcPeer=kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(options,function(error){if(error)return console.log(error);this.generateOffer(function(error,sdpOffer){error?console.log(error):$scope.ws.methods.viewerStart(localStorage.getItem("access_token"),sdpOffer,$scope.cameraId)})})}},$scope.disconnectViewer=function(){$scope.ws.methods.disconnectViewer(localStorage.getItem("access_token"))},$scope.enterViewer=function(){$scope.ws.methods.enterViewer(localStorage.getItem("access_token"),oId)},$scope.exitViewer=function(){$scope.ws.methods.exitViewer(localStorage.getItem("access_token"),oId)},$scope.getComments=function(){$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=getComments",method:"GET",params:{id:oId}}).then(function(result){$scope.comments=result.data.comments})},$scope.getTranslationWatchers=function(){$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=getWatchersByUserId",method:"GET",params:{id:$scope.cameraId}}).then(function(result){$scope.translationWatchers=result.data.watchers.length})},$scope.initWs(),"business"===$scope.translationType?($scope.viewer(),$scope.getComments(),$scope.getTranslationWatchers(),$scope.translationType="business"):"Viewer"===$scope.translationType?($scope.enterViewer(),$scope.getComments(),$scope.getTranslationWatchers(),$scope.translationType="Viewer"):"Presenter"===$scope.translationType&&($scope.getCameraId(),$scope.getComments(),$scope.getTranslationWatchers(),$scope.translationType="Presenter"),$scope.fullScreenVideo=function(){1<$scope.cameras.length&&($scope.showArrow=!0),"web"==$scope.cameraClient?$scope.isWeb=!0:$scope.isWeb=!1,$scope.isFullVideo=!$scope.isFullVideo,$scope.isFullVideo?angular.element("#accountInfo").hide():($scope.isWeb=!1,angular.element("#accountInfo").show())},$scope.prevCamera=function(){$scope.cameraIndex--,$scope.cameraIndex<0&&($scope.cameraIndex=$scope.cameras.length-1),webRtcPeer.dispose(),webRtcPeer=null,$scope.cameraId=$scope.cameras[$scope.cameraIndex].id,$scope.viewer()},$scope.nextCamera=function(){$scope.cameraIndex++,$scope.cameraIndex==$scope.cameras.length&&($scope.cameraIndex=0),webRtcPeer.dispose(),webRtcPeer=null,$scope.cameraId=$scope.cameras[$scope.cameraIndex].id,$scope.viewer()}});