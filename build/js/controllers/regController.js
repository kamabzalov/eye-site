"use strict";eyeApp.controller("regController",function($scope,$http,$window){$scope.startReg=function(){if(!$.trim($scope.phone))return angular.element("form[name='userRegForm'] input").addClass("ng-invalid"),void alert("Некорректный ввод номера телефона");$scope.phone=$scope.phone.replace(/\(|\)|-/g,""),$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=registerTestStart",method:"GET",params:{phone:$scope.phone},headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"/"}}).then(function(result){result.data.success?$scope.nextStep(1):(alert("Произошла ошибка. Возможно такой номер уже зарегистрирован"),angular.element("form[name='userRegForm'] input").addClass("ng-invalid"))})},$scope.middleReg=function(){$.trim($scope.code)?$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=registerTestMiddle",method:"GET",params:{phone:$scope.phone,code:$scope.code},headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"/"}}).then(function(result){result.data.success?(angular.element("form[name='userRegForm'] input").addClass("success"),localStorage.setItem("id",result.data.identify),$scope.nextStep(1)):(alert("Введенный вами код неверен"),angular.element("form[name='userRegForm'] input").addClass("ng-invalid"))}):angular.element("form[name='userRegForm'] input").addClass("ng-invalid")},$scope.finishReg=function(){if(""==$.trim($scope.name)||"undefined"==$scope.name)return angular.element("form[name='userRegForm'] input").removeClass("success"),void angular.element("form[name='userRegForm'] input").addClass("ng-invalid");if(angular.element("form[name='userRegForm'] input").removeClass("ng-invalid"),angular.element("form[name='userRegForm'] input").addClass("success"),""==$.trim($scope.password)||"undefined"==$scope.password)return angular.element("form[name='userRegForm'] input").removeClass("success"),void $("form[name='userRegForm'] input").addClass("error");if(angular.element("form[name='userRegForm'] input").removeClass("ng-invalid"),angular.element("form[name='userRegForm'] input").addClass("success"),""==$.trim($scope.email)||"undefined"==$scope.email)return angular.element("form[name='userRegForm'] input").removeClass("success"),void angular.element("form[name='userRegForm'] input").addClass("ng-invalid");angular.element("form[name='userRegForm'] input").removeClass("ng-invalid"),angular.element("form[name='userRegForm'] input").addClass("success");var file=document.querySelector("input[type=file]").files[0];void 0!==file?makeBase64(file,function(avatar){var fd=new FormData;fd.append("id",localStorage.getItem("id")),fd.append("name",$scope.name),fd.append("password",$scope.password),fd.append("email",$scope.email),fd.append("avatar",avatar),$http.post("https://api.eyeinc.ru/v0.9/index.php?c=api&m=registerTestFinish",fd,{withCredentials:!1,headers:{"Content-Type":void 0},transformRequest:angular.identity,params:{fd:fd}}).then(function(result){localStorage.setItem("access_token",result.data.token.auth.access_token),$scope.getAuthUserPage(),$window.location.href="/"})}):angular.element("span.icon-eye-plus").addClass("ng-touched ng-invalid")},$scope.startCompanyReg=function(){return""==$.trim($scope.phone)||"undefined"==$scope.phone?(angular.element("form[name='companyRegForm'] input").removeClass("success"),void angular.element("form[name='companyRegForm'] input").addClass("ng-invalid")):(angular.element("form[name='companyRegForm'] input").removeClass("ng-invalid"),angular.element("form[name='companyRegForm'] input").addClass("success"),""==$.trim($scope.email)||"undefined"==$scope.email?(angular.element("form[name='companyRegForm'] input").removeClass("success"),void angular.element("form[name='companyRegForm'] input").addClass("ng-invalid")):(angular.element("form[name='companyRegForm'] input").removeClass("ng-invalid"),angular.element("form[name='companyRegForm'] input").addClass("success"),$scope.isEmail?$scope.isEmail=1:$scope.isEmail=0,$scope.phone=$scope.phone.replace(/\(|\)|-/g,""),void $http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=registerBuisnessStart",method:"GET",params:{phone:$scope.phone,email:$scope.email,isEmail:$scope.isEmail}}).then(function(result){result.data.success?(angular.element("form[name='companyRegForm'] input").removeClass("success"),angular.element("form[name='companyRegForm'] input").removeClass("ng-invalid"),$scope.nextStep(1)):(angular.element("form[name='companyRegForm'] input").removeClass("success"),angular.element("form[name='companyRegForm'] input").addClass("ng-invalid"),alert("Произошла ошибка. Возможно, такой номер или email уже есть в нашей базе"))})))},$scope.middleCompanyReg=function(){if(""==$.trim($scope.code)||"undefined"==$scope.code)return angular.element("form[name='companyRegForm'] input").removeClass("success"),void angular.element("form[name='companyRegForm'] input").addClass("ng-invalid");$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=registerBuisnessMiddle",method:"GET",params:{login:$scope.phone,code:$scope.code,isEmail:$scope.isEmail}}).then(function(result){result.data.success?(angular.element("form[name='companyRegForm'] input").removeClass("success"),angular.element("form[name='companyRegForm'] input").removeClass("ng-invalid"),localStorage.setItem("id",result.data.identify),$scope.nextStep(1)):alert("Вы ввели неверный код")})},$scope.finishCompanyReg=function(){if(""==$.trim($scope.company)||"undefined"==$scope.company)return angular.element("form[name='companyRegForm'] input[name=company]").removeClass("success"),void angular.element("form[name='companyRegForm'] input[name=company]").addClass("ng-invalid");if(angular.element("form[name='companyRegForm'] input[name=company]").removeClass("ng-invalid"),angular.element("form[name='companyRegForm'] input[name=company]").addClass("success"),""==$.trim($scope.password)||"undefined"==$scope.password)return angular.element("form[name='companyRegForm'] input[name=password]").removeClass("success"),void angular.element("form[name='companyRegForm'] input[name=password]").addClass("ng-invalid");if(angular.element("form[name='companyRegForm'] input[name=password]").removeClass("ng-invalid"),angular.element("form[name='companyRegForm'] input[name=password]").addClass("success"),""==$.trim($scope.repeatPassword)||"undefined"==$scope.repeatPassword)return angular.element("form[name='companyRegForm'] input[name=repeatPassword]").removeClass("success"),void angular.element("form[name='companyRegForm'] input[name=repeatPassword]").addClass("ng-invalid");if(angular.element("form[name='companyRegForm'] input[name=repeatPassword]").removeClass("ng-invalid"),angular.element("form[name='companyRegForm'] input[name=repeatPassword]").addClass("success"),""==$.trim($scope.calls)||"undefined"==$scope.calls)return angular.element("form[name='companyRegForm'] input[name=calls]").removeClass("success"),void angular.element("form[name='companyRegForm'] input[name=calls]").addClass("ng-invalid");if(angular.element("form[name='companyRegForm'] input[name=calls]").removeClass("ng-invalid"),angular.element("form[name='companyRegForm'] input[name=calls]").addClass("success"),""==$.trim($scope.address)||"undefined"==$scope.address)return angular.element("form[name='companyRegForm'] input[name=address]").removeClass("success"),void angular.element("form[name='companyRegForm'] input[name=address]").addClass("ng-invalid");if(angular.element("form[name='companyRegForm'] input[name=address]").removeClass("ng-invalid"),angular.element("form[name='companyRegForm'] input[name=address]").addClass("success"),""==$.trim($scope.category)||"undefined"==$scope.category)return angular.element("form[name='companyRegForm'] #category").removeClass("success"),void angular.element("form[name='companyRegForm'] #category").addClass("ng-invalid");angular.element("form[name='companyRegForm'] #category").removeClass("ng-invalid"),angular.element("form[name='companyRegForm'] #category").addClass("success"),$scope.address=angular.element("#address").val();var file=document.querySelector("input[type=file]").files[0];void 0!==file?makeBase64(file,function(avatar){$scope.calls=$scope.calls.replace(/\(|\)|-/g,"");var fd=new FormData;fd.append("id",localStorage.getItem("id")),fd.append("name",$scope.company),fd.append("password",$scope.password),fd.append("email",$scope.email),fd.append("avatar",avatar),fd.append("address",$scope.address),fd.append("lat",localStorage.getItem("lat")),fd.append("lng",localStorage.getItem("lng")),fd.append("category",$scope.category),fd.append("calls",$scope.calls),$http.post("https://api.eyeinc.ru/v0.9/index.php?c=api&m=registerBuisnessFinish",fd,{withCredentials:!1,headers:{"Content-Type":void 0},transformRequest:angular.identity,params:{fd:fd}}).then(function(result){localStorage.setItem("access_token",result.data.token.auth.access_token),$scope.nextStep(1)})}):angular.element("span.icon-eye-plus").addClass("ng-touched ng-invalid")},$scope.authCompany=function(){$scope.getAuthUserPage(),$window.location.href="/"}});