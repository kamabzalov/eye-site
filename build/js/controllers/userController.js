"use strict";eyeApp.controller("userController",function($scope,$http,$window,$rootScope,$websocket,$timeout){var currentTimeStr;$scope.getAuthUserPage=function(){$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=getProfile",method:"GET"}).then(function(result){$scope.accountProfileId=result.data.profile.id,$scope.accountWatchers=result.data.profile.watchers,$scope.accountFollowers=result.data.profile.followers,$scope.accountLikes=result.data.profile.likes,$scope.accountName=result.data.profile.name,$scope.accountAvatar=result.data.profile.avatar,$scope.accountType=result.data.profile.type,$scope.accountUncheckedUsers=result.data.profile.unchecked,$scope.accountUnreaded=result.data.profile.unreaded,$scope.getWallByUserId($scope.accountProfileId)}).catch(function(response){401===response.status&&$scope.refreshAccessToken(function(success){success?$scope.getAuthUserPage():$scope.logout()})})},localStorage.getItem("access_token")&&$scope.getAuthUserPage(),$scope.logout=function(){localStorage.clear(),$window.location.href="/"},$scope.getChatList=function(){$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=getChatList",method:"GET"}).then(function(result){$scope.dialogs=result.data.list})},$scope.getMyFavorites=function(){$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=getFavoritesByUserId",method:"GET",params:{userId:localStorage.getItem("user_id")}}).then(function(result){$scope.myFavoritesList=result.data.followersTo})},$scope.getMyFollowers=function(){$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=getFollowersByUserId",method:"GET",params:{userId:localStorage.getItem("user_id")}}).then(function(result){$scope.countFollowers=result.data.followersMe.length,$scope.myFollowersMe=result.data.followersMe})},$scope.searchUsers=function(searchRequest){$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=searchUsers",params:{username:searchRequest}}).then(function(response){0<response.data.search.length?$scope.results=response.data.search:$scope.results=!1},function(response){})},$scope.getMyCameras=function(){$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=getMyCameras",method:"GET",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(result){$scope.camerasList=result.data.cameras})},$scope.addNewCamera=function(){$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=addStaticCamera",method:"POST",data:$.param({name:$scope.cameraName,uri:$scope.cameraURL}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(result){result.data.success?alert("Камера успешно добавлена"):alert("Ошибка добавления камеры"),$scope.panelType="",$scope.toggleElement(!0)})},$scope.deleteCamera=function(id){$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=deletecamera",method:"POST",data:$.param({id:id}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(result){result.data.success?alert("Камера удалена"):alert("Ошибка удаления камеры")}),$scope.panelType="",$scope.getMyCameras()},$scope.getWallByUserId=function(id){id||(id=localStorage.getItem("user_id")),$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=getWallByUserId",method:"GET",params:{userId:id}}).then(function(response){null!=response.data.wall&&($scope.wallInformation=response.data.wall.information,$scope.wallImage=response.data.wall.url)})},$scope.createWall=function(){var file=document.getElementById("wallCreateFile").files[0];makeBase64(file,function(wallCreateAvatar){var fd=new FormData;fd.append("textInformation",$scope.wallCreateText),fd.append("imageInformation",wallCreateAvatar),$http.post("https://api.eyeinc.ru/v0.9/index.php?c=api&m=createWall",fd,{withCredentials:!1,headers:{"Content-Type":void 0},transformRequest:angular.identity,params:{fd:fd}}).then(function(response){response.data.success?$window.location.reload():alert("Не удалось создать стену. Возможно, вы заполнили не все поля")})})},$scope.updateWall=function(){var updateFile=document.getElementById("wallUpdateFile").files[0];makeBase64(updateFile,function(wallUpdateAvatar){var fd=new FormData;fd.append("textInformation",$scope.wallUpdateText),fd.append("imageInformation",wallUpdateAvatar),$http.post("https://api.eyeinc.ru/v0.9/index.php?c=api&m=updateWall",fd,{withCredentials:!1,headers:{"Content-Type":void 0},transformRequest:angular.identity,params:{fd:fd}}).then(function(response){response.data.success?$window.location.reload():alert("Не удалось обновить стену. Возможно, вы заполнили не все поля")})})},$scope.deleteWall=function(){$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=deleteWall",method:"GET"}).then(function(response){$scope.wallInformation="",$scope.wallImage="",alert("Вы успешно удалили вашу стену"),$window.location.reload()})},$scope.closeProfile=function(){$scope.userId=!1,$scope.isOpenChat=!1,$scope.startTranslation(!1,"Viewer")},$scope.getFavoritesByUserId=function(id){id||(id=localStorage.getItem("user_id")),$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=getFavoritesByUserId",method:"GET",params:{userId:id}}).then(function(result){$scope.favoritesList=result.data.followersTo},function(response){401==response.status&&alert("Вы должны авторизоваться, чтобы просматривать данный аккаунт")})},$scope.getFollowersByUserId=function(id){id||(id=localStorage.getItem("user_id")),$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=getFollowersByUserId",method:"GET",params:{userId:id}}).then(function(result){$scope.followersList=result.data.followersMe})},$scope.subscribeToProfile=function(id){$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=follow",method:"GET",headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{id:id}}).then(function(result){$scope.isFollow=result.data.follow,$scope.userFollowers=result.data.follower_count,$scope.getFollowersByUserId(id)},function(response){401==response.status&&alert("Вы должны авторизоваться, чтобы подписаться на данный аккаунт")})},$scope.openChat=function(isOpenChat,userId){$scope.isOpenChat=!isOpenChat,$rootScope.obj.methods.enterChat(localStorage.getItem("access_token"),userId),$scope.isOpenChat?(angular.element("footer").hide(),angular.element("#panel").hasClass("ng-hide")?(angular.element("#chat").css({marginLeft:LEFTASIDEWIDTH,width:angular.element("body").outerWidth()-LEFTASIDEWIDTH-RIGHTASIDEWIDTH}),angular.element("#chat input").css({width:"70%"}),isMobileDevice()&&angular.element("#chat").css({marginLeft:MOBILELEFTASIDEWIDTH,width:angular.element("body").outerWidth()-MOBILELEFTASIDEWIDTH-RIGHTASIDEWIDTH})):$scope.isShowAccountPanel?(isMobileDevice()?angular.element("#chat").css({marginLeft:MOBILELEFTASIDEWIDTH+INFOPANELWIDTH,width:angular.element("body").outerWidth()-MOBILELEFTASIDEWIDTH-INFOPANELWIDTH-RIGHTASIDEWIDTH}):angular.element("#chat").css({marginLeft:LEFTASIDEWIDTH+INFOPANELWIDTH,width:angular.element("body").outerWidth()-LEFTASIDEWIDTH-INFOPANELWIDTH-RIGHTASIDEWIDTH}),angular.element("#chat input").css({width:"65%"})):($scope.isShowAccountPanel=!0,angular.element("#chat").css({marginLeft:LEFTASIDEWIDTH,width:angular.element("body").outerWidth()-LEFTASIDEWIDTH-RIGHTASIDEWIDTH}),angular.element("#chat input").css({width:"85%"}))):angular.element("footer").show()},$scope.getChatWithUser=function(userId){$timeout(function(){var music=document.querySelectorAll('*[id^="music-"]'),pButton=document.querySelectorAll('*[id^="pButton-"]'),playhead=document.querySelectorAll('*[id^="playhead-"]'),timeline=document.querySelectorAll('*[id^="timeline-"]'),timer=document.querySelectorAll('*[id^="timer-"]');pButton.forEach(function(item,i,arr){var timelineWidth=156;pButton[i].addEventListener("click",function(){music[i].paused?music[i].play():music[i].pause(),$("#"+pButton[i].id+" .icon-eye-play").toggleClass("icon-eye-pause")}),music[i].addEventListener("timeupdate",timeUpdate,!1),currentTimeStr=Math.floor(music[i].currentTime-Math.floor(music[i].currentTime/60)<10)?Math.floor(music[i].duration/60)+":0"+Math.floor(music[i].currentTime-Math.floor(music[i].currentTime/60)):Math.floor(music[i].duration/60)+":"+Math.floor(music[i].currentTime-Math.floor(music[i].currentTime/60)),timer[i].innerHTML=currentTimeStr,timeline[i].addEventListener("click",function(event){moveplayhead(event),music[i].currentTime=music[i].duration*event.clientX-timeline[i].getBoundingClientRect().left/timelineWidth},!1),playhead[i].addEventListener("mousedown",function(){onplayhead=!0,window.addEventListener("mousemove",moveplayhead,!0),music[i].removeEventListener("timeupdate",timeUpdate,!1)},!1),window.addEventListener("mouseup",function(event){1==onplayhead&&(moveplayhead(event),window.removeEventListener("mousemove",moveplayhead,!0),music[i].currentTime=music[i].duration*event.clientX-timeline[i].getBoundingClientRect().left/timelineWidth,music[i].addEventListener("timeupdate",timeUpdate,!1));onplayhead=!1},!1);var onplayhead=!1;function moveplayhead(event){var newMargLeft=event.clientX-timeline[i].getBoundingClientRect().left;0<=newMargLeft&&newMargLeft<=timelineWidth&&(playhead[i].style.marginLeft=newMargLeft+"px"),newMargLeft<0&&(playhead[i].style.marginLeft="0px"),timelineWidth<newMargLeft&&(playhead[i].style.marginLeft=timelineWidth+"px")}function timeUpdate(){var playPercent=timelineWidth*(music[i].currentTime/music[i].duration);playhead[i].style.marginLeft=playPercent+"px",currentTimeStr=Math.floor(music[i].currentTime-Math.floor(music[i].currentTime/60)<10)?Math.floor(music[i].duration/60)+":0"+Math.floor(music[i].currentTime-Math.floor(music[i].currentTime/60)):Math.floor(music[i].duration/60)+":"+Math.floor(music[i].currentTime-Math.floor(music[i].currentTime/60)),timer[i].innerHTML=currentTimeStr}})},2e3),localStorage.setItem("time",0),$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=getChatWithUser",method:"GET",params:{id:userId,time:0}}).then(function(result){$scope.isScroll=!(result.data.chat.length<50);for(var i=0;i<result.data.chat.length;i++)result.data.chat[i].receiver=result.data.chat[i].from_user_id!=localStorage.getItem("user_id");for(var j=0;j<result.data.chat.length-1;j++)result.data.chat[j].messagesDay=$scope.diffDate(result.data.chat[j].date_msg,result.data.chat[j+1].date_msg);var temp=result.data.chat.reverse();$scope.messagesWithUser=temp,localStorage.setItem("time",result.data.time),localStorage.setItem("to_user_id",userId)}),angular.element("#chat ul").animate({scrollTop:"10000px"},"fast")},$scope.diffDate=function(date1,date2){var dateOut1=new Date(1e3*date1);return 0!=new Date(1e3*date2).getDate()-dateOut1.getDate()?$scope.getDateAndMonth(dateOut1):0},$scope.getDateAndMonth=function(date1){var month=["Января","Февраля","Марта","Апреля","Мая","Июня","Июля","Августа","Сентября","Октября","Ноября","Декабря"][date1.getMonth()];return date1.getDate()+" "+month},$scope.changePassword=function(){$http({url:"https://api.eyeinc.ru/v0.9/index.php?c=api&m=new_password",method:"POST",data:$.param({oldpassword:$scope.oldpassword,newpassword:$scope.newpassword}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(result){result.data.success?alert("Ваш пароль успешно изменен"):alert("Произошла ошибка"),$scope.toggleElement(!0,!1)})},$scope.changePersonalData=function(){var fd=new FormData;if(void 0===$scope.login&&($scope.login=$scope.$parent.accountName),$scope.base64){var arr=$scope.base64.split(",");urltoFile($scope.base64,"avatar",arr[0].split(":")[1].split(";")[0]).then(function(file){fd.append("AVATAR",file),fd.append("name",$scope.login),$http.post("https://api.eyeinc.ru/v0.9/index.php?c=api&m=change_profile",fd,{withCredentials:!1,headers:{"Content-Type":void 0},transformRequest:angular.identity,params:{fd:fd}}).then(function(result){$scope.modalType="",$window.location.reload()})})}else fd.append("name",$scope.login),$http.post("https://api.eyeinc.ru/v0.9/index.php?c=api&m=change_profile",fd,{withCredentials:!1,headers:{"Content-Type":void 0},transformRequest:angular.identity,params:{fd:fd}}).then(function(result){$scope.modalType="",$window.location.reload()})}});